<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Live GPS Tracker</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  
  <!-- QR Code Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }
    #cesiumContainer {
      width: 100%;
      height: 100%;
    }
    .cesium-viewer-toolbar,
    .cesium-viewer-animationContainer,
    .cesium-viewer-timelineContainer,
    .cesium-viewer-bottom,
    .cesium-viewer-fullscreenButton {
      display: none !important;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 15px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 1000;
      max-width: 280px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #status .title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
    }
    #status .id {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 8px;
      word-break: break-all;
    }
    #version {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 11px;
      z-index: 1000;
      font-family: monospace;
    }
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 1000;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 90%;
    }
    .btn {
      background: rgba(0, 150, 255, 0.95);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn:active {
      transform: scale(0.95);
    }
    .btn-start { background: rgba(34, 197, 94, 0.95); }
    .btn-stop { background: rgba(239, 68, 68, 0.95); }
    .btn-center { background: rgba(59, 130, 246, 0.95); }
    .btn-reset { background: rgba(249, 115, 22, 0.95); }
    .btn-share { background: rgba(168, 85, 247, 0.95); }
    #modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    #modal.show {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }
    .modal-text {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    .link-box {
      background: #f3f4f6;
      padding: 12px;
      border-radius: 8px;
      word-break: break-all;
      font-size: 13px;
      margin-bottom: 15px;
      color: #333;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }
    .modal-btn-primary {
      background: #8b5cf6;
      color: white;
    }
    .modal-btn-secondary {
      background: #e5e7eb;
      color: #333;
    }
    #compassBtn {
      position: absolute;
      bottom: 140px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #333;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: #e74c3c;
      transition: all 0.2s;
    }
    #compassBtn:hover {
      transform: scale(1.05);
      background: rgba(255, 255, 255, 1);
    }
    #compassBtn:active {
      transform: scale(0.95);
    }
    #qrContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    #qrcode {
      background: white;
      padding: 20px;
      border-radius: 10px;
    }
    #timeline {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      padding: 15px 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #timelineControls {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #timelineSlider {
      flex: 1;
      height: 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.2);
      outline: none;
      -webkit-appearance: none;
      cursor: pointer;
    }
    #timelineSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00bcd4;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #timelineSlider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00bcd4;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #timelineTime {
      color: white;
      font-size: 14px;
      font-weight: bold;
      min-width: 120px;
      text-align: center;
      font-family: monospace;
    }
    #timelinePlayBtn {
      background: #00bcd4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
    }
    #timelinePlayBtn:hover {
      background: #00acc1;
    }
    #timelineInfo {
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  
  <div id="version">
    v1.0.6<br>
    2025-01-27 03:15:28
  </div>
  
  <button id="compassBtn" title="Nach Norden ausrichten">N</button>
  
  <div id="timeline">
    <div id="timelineControls">
      <button id="timelinePlayBtn">‚ñ∂ Live</button>
      <div id="timelineTime">--:--:--</div>
      <input type="range" id="timelineSlider" min="0" max="100" value="100" step="1">
    </div>
    <div id="timelineInfo">Keine Trackingdaten</div>
  </div>
  
  <div id="status">
    <div class="title">üîÑ Initialisiere...</div>
    <div id="statusText"></div>
    <div class="id" id="trackingId"></div>
  </div>

  <div id="controls"></div>

  <div id="modal">
    <div class="modal-content">
      <div class="modal-title">üì§ Link zum Teilen</div>
      <div class="modal-text">Teile diesen Link, damit andere deine Live-Position sehen k√∂nnen:</div>
      <div class="link-box" id="shareLink"></div>
      <div id="qrContainer">
        <div id="qrcode"></div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-primary" onclick="copyLink()">üìã Link kopieren</button>
        <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Schlie√üen</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyCUj_a9iIQ3gnVYFw72OV3M-bnr0huUdMQ",
      authDomain: "track-me-463d7.firebaseapp.com",
      databaseURL: "https://track-me-463d7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "track-me-463d7",
      storageBucket: "track-me-463d7.firebasestorage.app",
      messagingSenderId: "398272695277",
      appId: "1:398272695277:web:c59d7a23214327497535e4"
    };

    let database;
    let viewer;
    let trackingId = localStorage.getItem('trackingId') || 'track_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('trackingId', trackingId);

    const urlParams = new URLSearchParams(window.location.search);
    const viewTrackingId = urlParams.get('track');
    const isViewer = viewTrackingId && viewTrackingId !== trackingId;
    const activeTrackingId = isViewer ? viewTrackingId : trackingId;

    let positions = [];
    let isTracking = false;
    let watchId = null;
    let currentPosition = null;
    let userInteracting = false;
    let lastUpdate = 0;
    let isTimelinePlaying = true;
    let timelineIndex = -1;
    let gpsBuffer = [];

    // Warte bis alles geladen ist
    window.addEventListener('load', function() {
      // Firebase initialisieren
      try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        document.querySelector('#status .title').textContent = '‚úÖ Firebase verbunden';
      } catch (e) {
        console.error("Firebase Fehler:", e);
        document.getElementById('statusText').textContent = "‚ö†Ô∏è Firebase nicht konfiguriert";
      }

      // Cesium Token - Aktualisierter √∂ffentlicher Token
      Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmMTRjYzBkZS1hY2JkLTRlMjctYjU5Yi0xODY1MjQzODNmMjkiLCJpZCI6MjU5LCJpYXQiOjE3MjgzNzQ4MzB9.L4TMLu_TTZKOTQH9HpBnVDTp1Vqvlhk9P4oNGKP_1OA';

      // Cesium Viewer erstellen mit Basis-Imagery
      viewer = new Cesium.Viewer('cesiumContainer', {
        animation: false,
        timeline: false,
        baseLayerPicker: false,
        geocoder: false,
        homeButton: false,
        sceneModePicker: false,
        navigationHelpButton: false,
        fullscreenButton: false,
        vrButton: false,
        infoBox: false,
        selectionIndicator: false,
        shadows: false,
        terrainProvider: new Cesium.EllipsoidTerrainProvider(),
        imageryProvider: new Cesium.OpenStreetMapImageryProvider({
          url: 'https://a.tile.openstreetmap.org/'
        })
      });

      // Entferne Cesium Logo und Credits f√ºr bessere Sicht
      viewer.cesiumWidget.creditContainer.style.display = "none";
      
      // Setze initiale Kamera-Position (Global view)
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(10.0, 50.0, 10000000)
      });

      // Interaktions-Handler
      const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
      handler.setInputAction(function() { userInteracting = true; }, Cesium.ScreenSpaceEventType.LEFT_DOWN);
      handler.setInputAction(function() { userInteracting = true; }, Cesium.ScreenSpaceEventType.WHEEL);
      handler.setInputAction(function() { userInteracting = true; }, Cesium.ScreenSpaceEventType.PINCH_START);

      // Kompass-Button Event
      document.getElementById('compassBtn').addEventListener('click', function() {
        if (viewer) {
          viewer.camera.flyTo({
            destination: viewer.camera.position,
            orientation: {
              heading: 0,
              pitch: Cesium.Math.toRadians(-90),
              roll: 0.0
            },
            duration: 1.0
          });
        }
      });

      // Timeline Events
      const timelineSlider = document.getElementById('timelineSlider');
      const timelinePlayBtn = document.getElementById('timelinePlayBtn');
      
      timelineSlider.addEventListener('input', function() {
        isTimelinePlaying = false;
        timelinePlayBtn.textContent = '‚ñ∂ Live';
        const index = parseInt(this.value);
        showTimelinePosition(index);
      });
      
      timelinePlayBtn.addEventListener('click', function() {
        isTimelinePlaying = !isTimelinePlaying;
        if (isTimelinePlaying) {
          this.textContent = '‚è∏ Pause';
          timelineSlider.value = positions.length - 1;
          if (positions.length > 0) {
            showTimelinePosition(positions.length - 1);
          }
        } else {
          this.textContent = '‚ñ∂ Live';
        }
      });

      // UI aktualisieren
      updateUI();

      // Lade Positionen aus Firebase
      if (database) {
        database.ref('tracks/' + activeTrackingId + '/positions').on('value', function(snapshot) {
          const data = snapshot.val();
          if (data) {
            positions = data;
            renderPositions(positions);
            
            if (isViewer) {
              document.getElementById('statusText').innerHTML = 
                'Live-Tracking aktiv<br>' +
                'Punkte: ' + positions.length;
            }
          }
        });
      }
    });

    function getSpeedColor(speedKmh) {
      const maxSpeed = 30;
      const normalized = Math.min(speedKmh / maxSpeed, 1);
      
      if (normalized < 0.33) {
        const t = normalized / 0.33;
        return Cesium.Color.fromCssColorString('rgb(' + Math.round(t * 255) + ', 255, 0)');
      } else if (normalized < 0.66) {
        const t = (normalized - 0.33) / 0.33;
        return Cesium.Color.fromCssColorString('rgb(255, ' + Math.round(255 - t * 100) + ', 0)');
      } else {
        const t = (normalized - 0.66) / 0.34;
        return Cesium.Color.fromCssColorString('rgb(255, ' + Math.round(155 - t * 155) + ', 0)');
      }
    }

    // Echolot-Puls-Effekt
    function addPulseEffect(lon, lat, alt) {
      if (!viewer) return;
      
      const position = Cesium.Cartesian3.fromDegrees(lon, lat, alt);
      const pulseEntity = viewer.entities.add({
        position: position,
        ellipse: {
          semiMinorAxis: 1.0,
          semiMajorAxis: 1.0,
          height: 0,
          material: Cesium.Color.CYAN.withAlpha(0.8),
          heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
        }
      });

      let startTime = Date.now();
      let animationDuration = 2000; // 2 Sekunden
      
      function animate() {
        let elapsed = Date.now() - startTime;
        let progress = elapsed / animationDuration;
        
        if (progress >= 1.0) {
          viewer.entities.remove(pulseEntity);
          return;
        }
        
        let radius = 1 + (progress * 50); // Von 1m bis 50m
        let alpha = 0.8 * (1 - progress); // Fade out
        
        pulseEntity.ellipse.semiMinorAxis = radius;
        pulseEntity.ellipse.semiMajorAxis = radius;
        pulseEntity.ellipse.material = Cesium.Color.CYAN.withAlpha(alpha);
        
        requestAnimationFrame(animate);
      }
      
      animate();
    }

    // GPS-Gl√§ttung mit Moving Average
    function smoothGPSPosition(lat, lon, accuracy) {
      // Nur genaue Messungen verwenden (< 50m Genauigkeit)
      if (accuracy > 50) {
        return null;
      }
      
      gpsBuffer.push({ lat: lat, lon: lon, accuracy: accuracy });
      
      // Behalte nur die letzten 5 Messungen
      if (gpsBuffer.length > 5) {
        gpsBuffer.shift();
      }
      
      // Gewichteter Durchschnitt (genauere Messungen haben mehr Gewicht)
      let totalWeight = 0;
      let weightedLat = 0;
      let weightedLon = 0;
      
      gpsBuffer.forEach(function(point) {
        const weight = 1 / point.accuracy; // Bessere Genauigkeit = h√∂heres Gewicht
        weightedLat += point.lat * weight;
        weightedLon += point.lon * weight;
        totalWeight += weight;
      });
      
      return {
        lat: weightedLat / totalWeight,
        lon: weightedLon / totalWeight
      };
    }

    // Timeline Position anzeigen
    function showTimelinePosition(index) {
      if (index < 0 || index >= positions.length || !viewer) return;
      
      timelineIndex = index;
      const pos = positions[index];
      
      // Uhrzeit anzeigen
      const date = new Date(pos.timestamp);
      const timeStr = date.toLocaleTimeString('de-DE');
      document.getElementById('timelineTime').textContent = timeStr;
      
      // Info anzeigen
      const speedKmh = (pos.speed * 3.6).toFixed(1);
      document.getElementById('timelineInfo').textContent = 
        'Punkt ' + (index + 1) + ' von ' + positions.length + ' | ' + speedKmh + ' km/h';
      
      // Kamera zentrieren
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(pos.lon, pos.lat, 1000),
        orientation: {
          heading: 0,
          pitch: Cesium.Math.toRadians(-90),
          roll: 0.0
        },
        duration: 0.5
      });
      
      // Highlight diesen Punkt
      renderPositions(positions, index);
    }

    // Update Timeline
    function updateTimeline() {
      if (positions.length === 0) {
        document.getElementById('timelineInfo').textContent = 'Keine Trackingdaten';
        document.getElementById('timelineTime').textContent = '--:--:--';
        return;
      }
      
      const slider = document.getElementById('timelineSlider');
      slider.max = positions.length - 1;
      
      if (isTimelinePlaying) {
        slider.value = positions.length - 1;
        const lastPos = positions[positions.length - 1];
        const date = new Date(lastPos.timestamp);
        document.getElementById('timelineTime').textContent = date.toLocaleTimeString('de-DE');
        
        const speedKmh = (lastPos.speed * 3.6).toFixed(1);
        document.getElementById('timelineInfo').textContent = 
          'Live-Tracking | ' + positions.length + ' Punkte | ' + speedKmh + ' km/h';
      }
    }

    function renderPositions(posArray, highlightIndex) {
      if (!viewer || posArray.length === 0) return;
      viewer.entities.removeAll();

      for (let i = 0; i < posArray.length - 1; i++) {
        const pos1 = Cesium.Cartesian3.fromDegrees(posArray[i].lon, posArray[i].lat, posArray[i].alt);
        const pos2 = Cesium.Cartesian3.fromDegrees(posArray[i + 1].lon, posArray[i + 1].lat, posArray[i + 1].alt);
        const speedKmh = posArray[i].speed * 3.6;
        
        viewer.entities.add({
          polyline: {
            positions: [pos1, pos2],
            width: 5,
            material: getSpeedColor(speedKmh),
            clampToGround: true
          }
        });
      }

      posArray.forEach(function(p, index) {
        const speedKmh = p.speed * 3.6;
        const isLatest = index === posArray.length - 1;
        const isHighlighted = highlightIndex !== undefined && index === highlightIndex;
        
        viewer.entities.add({
          position: Cesium.Cartesian3.fromDegrees(p.lon, p.lat, p.alt),
          point: {
            pixelSize: isHighlighted ? 20 : (isLatest ? 16 : 8),
            color: isHighlighted ? Cesium.Color.YELLOW : (isLatest ? Cesium.Color.CYAN : getSpeedColor(speedKmh)),
            outlineColor: Cesium.Color.WHITE,
            outlineWidth: isHighlighted ? 4 : (isLatest ? 3 : 2),
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
          }
        });
        
        // Echolot-Animation nur f√ºr neuesten Punkt im Live-Modus
        if (isLatest && isTimelinePlaying && highlightIndex === undefined) {
          addPulseEffect(p.lon, p.lat, p.alt);
        }
      });

      if (!userInteracting && posArray.length > 0 && highlightIndex === undefined) {
        const last = posArray[posArray.length - 1];
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(last.lon, last.lat, 1000),
          orientation: {
            heading: 0,
            pitch: Cesium.Math.toRadians(-90),
            roll: 0.0
          },
          duration: 0.5
        });
      }
      
      updateTimeline();
    }

    function savePosition(lat, lon, alt, speed) {
      if (!database) return;
      const posData = { lat: lat, lon: lon, alt: alt, speed: speed, timestamp: Date.now() };
      positions.push(posData);
      
      database.ref('tracks/' + activeTrackingId + '/positions').set(positions);
      database.ref('tracks/' + activeTrackingId + '/latest').set(posData);
      
      renderPositions(positions);
    }

    function startTracking() {
      if (!navigator.geolocation) {
        alert('GPS nicht verf√ºgbar');
        return;
      }

      isTracking = true;
      updateUI();

      watchId = navigator.geolocation.watchPosition(
        function(position) {
          const now = Date.now();
          currentPosition = position;

          if (now - lastUpdate >= 1000) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const alt = position.coords.altitude || 0;
            const speed = position.coords.speed || 0;
            const accuracy = position.coords.accuracy;

            // GPS-Gl√§ttung anwenden
            const smoothed = smoothGPSPosition(lat, lon, accuracy);
            
            if (smoothed) {
              savePosition(smoothed.lat, smoothed.lon, alt, speed);

              const speedKmh = (speed * 3.6).toFixed(1);
              document.getElementById('statusText').innerHTML = 
                'GPS aktiv<br>' +
                'Speed: ' + speedKmh + ' km/h<br>' +
                'Genauigkeit: ¬±' + Math.round(accuracy) + 'm<br>' +
                'Punkte: ' + positions.length;
            } else {
              document.getElementById('statusText').innerHTML = 
                'GPS aktiv (warte auf pr√§zise Messung)<br>' +
                'Genauigkeit: ¬±' + Math.round(accuracy) + 'm (zu ungenau)';
            }
            
            lastUpdate = now;
          }
        },
        function(error) {
          document.getElementById('statusText').textContent = 'GPS-Fehler: ' + error.message;
          isTracking = false;
          updateUI();
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    }

    function stopTracking() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      isTracking = false;
      updateUI();
      document.getElementById('statusText').textContent = 'Tracking gestoppt';
    }

    function centerOnPosition() {
      userInteracting = false;
      if (positions.length > 0 && viewer) {
        const last = positions[positions.length - 1];
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(last.lon, last.lat, 1000),
          orientation: {
            heading: 0,
            pitch: Cesium.Math.toRadians(-90),
            roll: 0.0
          },
          duration: 1.5
        });
      } else if (currentPosition && viewer) {
        const lat = currentPosition.coords.latitude;
        const lon = currentPosition.coords.longitude;
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(lon, lat, 1000),
          orientation: {
            heading: 0,
            pitch: Cesium.Math.toRadians(-90),
            roll: 0.0
          },
          duration: 1.5
        });
      }
    }

    function resetTracking() {
      if (confirm('Alle Trackingdaten l√∂schen?')) {
        positions = [];
        if (viewer) viewer.entities.removeAll();
        if (database) {
          database.ref('tracks/' + activeTrackingId).remove();
        }
        document.getElementById('statusText').textContent = 'Zur√ºckgesetzt';
      }
    }

    function showShareModal() {
      const link = window.location.origin + window.location.pathname + '?track=' + trackingId;
      document.getElementById('shareLink').textContent = link;
      
      // QR Code generieren
      const qrcodeContainer = document.getElementById('qrcode');
      qrcodeContainer.innerHTML = ''; // Alte QR-Codes l√∂schen
      
      new QRCode(qrcodeContainer, {
        text: link,
        width: 256,
        height: 256,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
      
      document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
    }

    function copyLink() {
      const link = window.location.origin + window.location.pathname + '?track=' + trackingId;
      navigator.clipboard.writeText(link).then(function() {
        alert('‚úÖ Link kopiert!');
        closeModal();
      });
    }

    function updateUI() {
      const controls = document.getElementById('controls');
      controls.innerHTML = '';

      if (isViewer) {
        document.querySelector('#status .title').textContent = 'üëÅÔ∏è Verfolgungs-Modus';
        document.getElementById('trackingId').textContent = 'Tracking ID: ' + viewTrackingId;
        
        const centerBtn = document.createElement('button');
        centerBtn.className = 'btn btn-center';
        centerBtn.textContent = 'üéØ Zentrieren';
        centerBtn.onclick = centerOnPosition;
        controls.appendChild(centerBtn);
      } else {
        document.querySelector('#status .title').textContent = 'üìç Dein Tracker';
        document.getElementById('trackingId').textContent = 'Deine ID: ' + trackingId;

        if (!isTracking) {
          const startBtn = document.createElement('button');
          startBtn.className = 'btn btn-start';
          startBtn.textContent = '‚ñ∂Ô∏è Start';
          startBtn.onclick = startTracking;
          controls.appendChild(startBtn);
        } else {
          const stopBtn = document.createElement('button');
          stopBtn.className = 'btn btn-stop';
          stopBtn.textContent = '‚è∏Ô∏è Stop';
          stopBtn.onclick = stopTracking;
          controls.appendChild(stopBtn);
        }

        const centerBtn = document.createElement('button');
        centerBtn.className = 'btn btn-center';
        centerBtn.textContent = 'üéØ Zentrieren';
        centerBtn.onclick = centerOnPosition;
        controls.appendChild(centerBtn);

        const resetBtn = document.createElement('button');
        resetBtn.className = 'btn btn-reset';
        resetBtn.textContent = 'üîÑ Reset';
        resetBtn.onclick = resetTracking;
        controls.appendChild(resetBtn);

        const shareBtn = document.createElement('button');
        shareBtn.className = 'btn btn-share';
        shareBtn.textContent = 'üì§ Teilen';
        shareBtn.onclick = showShareModal;
        controls.appendChild(shareBtn);
      }
    }
  </script>
</body>
</html>